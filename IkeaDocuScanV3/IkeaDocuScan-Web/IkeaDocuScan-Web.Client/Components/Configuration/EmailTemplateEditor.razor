@using IkeaDocuScan.Shared.DTOs.Configuration

<div class="row mb-3">
    <div class="col-md-12">
        <label class="form-label">Template Name <span class="text-danger">*</span></label>
        <input type="text" class="form-control" placeholder="e.g., Access Request Notification" @bind="Template.TemplateName" />
        @if (showValidation && string.IsNullOrWhiteSpace(Template.TemplateName))
        {
            <div class="invalid-feedback d-block">Template name is required</div>
        }
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <label class="form-label">Template Key <span class="text-danger">*</span></label>
        <input type="text" class="form-control" placeholder="e.g., AccessRequestNotification" @bind="Template.TemplateKey" readonly="@(Template.TemplateId.HasValue)" />
        @if (showValidation && string.IsNullOrWhiteSpace(Template.TemplateKey))
        {
            <div class="invalid-feedback d-block">Template key is required</div>
        }
        <div class="form-text">Unique identifier for programmatic lookup (cannot be changed after creation)</div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <label class="form-label">Category</label>
        <select class="form-select" @bind="Template.Category">
            <option value="Notifications">Notifications</option>
            <option value="Reminders">Reminders</option>
            <option value="Documents">Documents</option>
            <option value="System">System</option>
        </select>
    </div>
    <div class="col-md-6">
        <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" id="isActiveCheck" @bind="Template.IsActive" />
            <label class="form-check-label" for="isActiveCheck">Is Active</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="isDefaultCheck" @bind="Template.IsDefault" />
            <label class="form-check-label" for="isDefaultCheck">Is Default</label>
        </div>
    </div>
</div>

<div class="mb-3">
    <label class="form-label">Subject Line <span class="text-danger">*</span></label>
    <input type="text" class="form-control" placeholder="e.g., Access Request from {{Username}}" @bind="Template.Subject" />
    @if (showValidation && string.IsNullOrWhiteSpace(Template.Subject))
    {
        <div class="invalid-feedback d-block">Subject is required</div>
    }
    <div class="form-text">Supports placeholders like {{Username}}, {{Date}}, {{Count}}</div>
</div>

<div class="mb-3">
    <label class="form-label">HTML Body <span class="text-danger">*</span></label>
    <textarea class="form-control font-monospace" rows="15" placeholder="<html>...</html>" @bind="Template.HtmlBody"></textarea>
    @if (showValidation && string.IsNullOrWhiteSpace(Template.HtmlBody))
    {
        <div class="invalid-feedback d-block">HTML body is required</div>
    }
    <div class="form-text">
        Supports placeholders: {{Placeholder}} and loops: {{#LoopName}}...{{/LoopName}}
        <button type="button" class="btn btn-link btn-sm p-0 ms-2" @onclick="ShowPlaceholderHelp">
            <i class="fa fa-info-circle"></i> Show Available Placeholders
        </button>
    </div>
</div>

<div class="mb-3">
    <label class="form-label">Plain Text Body (Optional)</label>
    <textarea class="form-control font-monospace" rows="10" placeholder="Plain text version for email clients that don't support HTML" @bind="Template.PlainTextBody"></textarea>
    <div class="form-text">Fallback for email clients that don't support HTML</div>
</div>

<div class="mb-3">
    <label class="form-label">Placeholder Definitions (Optional)</label>
    <textarea class="form-control font-monospace" rows="5" placeholder='{"placeholders": [...]}' @bind="Template.PlaceholderDefinitions"></textarea>
    <div class="form-text">JSON documentation of available placeholders for this template</div>
</div>

<div class="d-flex justify-content-end gap-2 mt-3">
    <button type="button" class="btn btn-secondary" @onclick="OnCancel">
        <i class="fa fa-times me-2"></i>Cancel
    </button>
    <button type="button" class="btn btn-primary" @onclick="Save" disabled="@isSaving">
        @if (isSaving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        }
        <i class="fa fa-save me-2"></i>Save Template
    </button>
</div>

<!-- Placeholder Help Modal -->
@if (showPlaceholderModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Available Placeholders</h5>
                    <button type="button" class="btn-close" @onclick="HidePlaceholderHelp"></button>
                </div>
                <div class="modal-body">
                    <h6>Common Placeholders:</h6>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Placeholder</th>
                                <th>Description</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td><code>{{Username}}</code></td><td>User's username</td><td>john.doe</td></tr>
                            <tr><td><code>{{Date}}</code></td><td>Current date/time</td><td>04/11/2025 14:30</td></tr>
                            <tr><td><code>{{Count}}</code></td><td>Number of items</td><td>5</td></tr>
                            <tr><td><code>{{BarCode}}</code></td><td>Document barcode</td><td>12345</td></tr>
                            <tr><td><code>{{ApplicationUrl}}</code></td><td>Base app URL</td><td>https://docuscan.company.com</td></tr>
                        </tbody>
                    </table>

                    <h6 class="mt-3">Loop Structures:</h6>
                    <p>For repeating data (like action reminders or document lists):</p>
                    <pre class="bg-light p-3"><code>{{#ActionRows}}
  &lt;tr&gt;
    &lt;td&gt;{{BarCode}}&lt;/td&gt;
    &lt;td&gt;{{DocumentType}}&lt;/td&gt;
    &lt;td&gt;{{ActionDate}}&lt;/td&gt;
  &lt;/tr&gt;
{{/ActionRows}}</code></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HidePlaceholderHelp">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public required EmailTemplateDto Template { get; set; }
    [Parameter] public EventCallback<EmailTemplateDto> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private bool showPlaceholderModal;
    private bool isSaving;
    private bool showValidation;

    private async Task Save()
    {
        showValidation = true;

        if (string.IsNullOrWhiteSpace(Template.TemplateName) ||
            string.IsNullOrWhiteSpace(Template.TemplateKey) ||
            string.IsNullOrWhiteSpace(Template.Subject) ||
            string.IsNullOrWhiteSpace(Template.HtmlBody))
        {
            return;
        }

        isSaving = true;
        try
        {
            await OnSave.InvokeAsync(Template);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ShowPlaceholderHelp()
    {
        showPlaceholderModal = true;
    }

    private void HidePlaceholderHelp()
    {
        showPlaceholderModal = false;
    }
}
