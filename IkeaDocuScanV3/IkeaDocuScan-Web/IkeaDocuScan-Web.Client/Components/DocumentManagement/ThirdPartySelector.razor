@using IkeaDocuScan_Web.Client.Models
@using IkeaDocuScan.Shared.DTOs.CounterParties
@using IkeaDocuScan.Shared.Interfaces
@using Microsoft.JSInterop
@inject ICounterPartyService CounterPartyService
@inject ILogger<ThirdPartySelector> Logger
@inject IJSRuntime JSRuntime

<div class="third-party-selector">
    @* Search Box with Dropdown *@
    <div class="mb-3">
        <label class="form-label">Third Parties (Optional)</label>
        <div class="search-container">
            <input type="text"
                   class="form-control"
                   placeholder="Type to search and add third parties..."
                   value="@searchTerm"
                   @oninput="OnSearchChanged"
                   @onfocus="OnSearchFocus"
                   @onblur="OnSearchBlur"
                   @onkeydown="OnInputKeyDown"
                   disabled="@Disabled"
                   autocomplete="off"
                   role="combobox"
                   aria-autocomplete="list"
                   aria-expanded="@showDropdown"
                   aria-controls="tp-dropdown-list" />

            @if (showDropdown && !Disabled)
            {
                <div class="dropdown-results" @onmousedown:preventDefault>
                    @if (string.IsNullOrWhiteSpace(searchTerm))
                    {
                        <div class="dropdown-hint">
                            <i class="fa fa-info-circle me-2"></i>
                            Start typing to search through @availableThirdParties.Count third parties...
                        </div>
                    }
                    else if (!visibleThirdParties.Any())
                    {
                        <div class="dropdown-no-results">
                            <i class="fa fa-search me-2"></i>
                            No third parties found matching "@searchTerm"
                        </div>
                    }
                    else
                    {
                        <div class="dropdown-header">
                            <small class="text-muted">
                                Click to add â€¢ Showing @visibleThirdParties.Count of @filteredThirdParties.Count matches
                                @if (filteredThirdParties.Count > MaxVisibleItems)
                                {
                                    <span>(refine search to see more)</span>
                                }
                            </small>
                        </div>
                        <div class="dropdown-list" id="tp-dropdown-list" role="listbox">
                            @for (int i = 0; i < visibleThirdParties.Count; i++)
                            {
                                var item = visibleThirdParties[i];
                                var index = i;
                                var itemId = $"tp-item-{index}";
                                var isKeyboardSelected = selectedIndex == index;
                                <div class="dropdown-item @(isKeyboardSelected ? "keyboard-selected" : "")"
                                     @onclick="@(() => AddThirdParty(item))"
                                     @onmouseenter="@(() => OnMouseEnterItem(index))"
                                     id="@itemId"
                                     role="option"
                                     aria-selected="@isKeyboardSelected">
                                    <div class="dropdown-item-name">
                                        <strong>@HighlightMatch(item.Name, searchTerm)</strong>
                                        @if (!string.IsNullOrEmpty(item.CounterPartyNoAlpha))
                                        {
                                            <span class="text-muted ms-2">(@item.CounterPartyNoAlpha)</span>
                                        }
                                    </div>
                                    <div class="dropdown-item-details">
                                        <small class="text-muted">
                                            @item.City, @item.Country
                                        </small>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    @* Selected Third Parties Display *@
    @if (selectedItems.Any())
    {
        <div class="selected-third-parties">
            <small class="text-muted d-block mb-2">
                @selectedItems.Count selected third part@(selectedItems.Count == 1 ? "y" : "ies"):
            </small>
            <div class="third-party-chips">
                @foreach (var item in selectedItems)
                {
                    <div class="third-party-chip">
                        <span class="chip-text">
                            <strong>@item.Name</strong>
                            @if (!string.IsNullOrEmpty(item.City) || !string.IsNullOrEmpty(item.Country))
                            {
                                <span class="text-muted ms-1">(@item.City, @item.Country)</span>
                            }
                        </span>
                        <button class="btn-chip-remove"
                                @onclick="@(() => RemoveThirdParty(item))"
                                disabled="@Disabled"
                                title="Remove @item.Name">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .third-party-selector {
        width: 100%;
    }

    .search-container {
        position: relative;
    }

    .dropdown-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1050;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        margin-top: 2px;
        max-height: 350px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .dropdown-hint,
    .dropdown-no-results {
        padding: 20px;
        text-align: center;
        color: #6c757d;
    }

    .dropdown-header {
        padding: 8px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        flex-shrink: 0;
    }

    .dropdown-list {
        overflow-y: auto;
        max-height: 300px;
    }

    .dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.15s ease;
    }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: #e7f3ff;
        }

        .dropdown-item.keyboard-selected {
            background-color: #0d6efd !important;
            color: white;
            border-left: 4px solid #0a58ca;
            padding-left: 8px;
            font-weight: 500;
        }

        .dropdown-item.keyboard-selected .text-muted {
            color: rgba(255, 255, 255, 0.85) !important;
        }

        .dropdown-item.keyboard-selected mark.highlight {
            background-color: #ffc107;
            color: #000;
        }

    .dropdown-item-name {
        margin-bottom: 4px;
    }

    .dropdown-item-details {
        line-height: 1.3;
    }

    .selected-third-parties {
        margin-top: 12px;
    }

    .third-party-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .third-party-chip {
        display: inline-flex;
        align-items: center;
        padding: 6px 8px 6px 12px;
        background: #e7f3ff;
        border: 1px solid #0d6efd;
        border-radius: 20px;
        font-size: 0.9rem;
        gap: 8px;
    }

    .chip-text {
        line-height: 1.2;
    }

    .btn-chip-remove {
        background: transparent;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 0;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        transition: background-color 0.15s ease;
    }

        .btn-chip-remove:hover:not(:disabled) {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .btn-chip-remove:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    /* Search term highlighting */
    .highlight {
        background-color: yellow;
        font-weight: bold;
    }
</style>

@code {
    // PERFORMANCE: Maximum number of items to render in dropdown
    // This prevents rendering thousands of DOM elements and causing delays
    private const int MaxVisibleItems = 50;

    /// <summary>
    /// List of selected third party IDs (bound to ViewModel)
    /// </summary>
    [Parameter]
    public List<string> SelectedThirdPartyIds { get; set; } = new();

    /// <summary>
    /// Event callback when selected IDs change
    /// </summary>
    [Parameter]
    public EventCallback<List<string>> SelectedThirdPartyIdsChanged { get; set; }

    /// <summary>
    /// List of selected third party names (bound to ViewModel)
    /// </summary>
    [Parameter]
    public List<string> SelectedThirdPartyNames { get; set; } = new();

    /// <summary>
    /// Event callback when selected names change
    /// </summary>
    [Parameter]
    public EventCallback<List<string>> SelectedThirdPartyNamesChanged { get; set; }

    /// <summary>
    /// Whether the selector is disabled
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Optional filter by CounterPartyId (to show only related third parties)
    /// </summary>
    [Parameter]
    public string? FilterByCounterPartyId { get; set; }

    /// <summary>
    /// Pre-loaded counter parties (optional, passed from parent for performance)
    /// </summary>
    [Parameter]
    public List<CounterPartyDto>? CounterParties { get; set; }

    /// <summary>
    /// Event callback when component finishes loading
    /// </summary>
    [Parameter]
    public EventCallback OnLoadComplete { get; set; }

    // Internal state
    private List<ThirdPartyItem> allThirdParties = new();
    private List<ThirdPartyItem> availableThirdParties = new();
    private List<ThirdPartyItem> selectedItems = new();
    private List<ThirdPartyItem> filteredThirdParties = new();
    private List<ThirdPartyItem> visibleThirdParties = new();
    private string searchTerm = string.Empty;
    private bool showDropdown = false;
    private int selectedIndex = -1;

    protected override async Task OnInitializedAsync()
    {
        await LoadThirdParties();
        UpdateLists();

        // Signal parent that this component has completed initialization
        await OnLoadComplete.InvokeAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // If SelectedThirdPartyIds changed externally, update our lists
        UpdateLists();
    }

    private async Task LoadThirdParties()
    {
        try
        {
            List<CounterPartyDto> counterParties;

            // Use pre-loaded data if available, otherwise load
            if (CounterParties != null && CounterParties.Any())
            {
                counterParties = CounterParties;
                Logger.LogInformation("âœ… PERF: Using {Count} pre-loaded counterparties for third party selector", counterParties.Count);
            }
            else
            {
                counterParties = await CounterPartyService.GetAllAsync();
                Logger.LogInformation("Loaded {Count} counterparties for third party selector", counterParties.Count);
            }

            allThirdParties = counterParties
                .Where(cp => cp.DisplayAtCheckIn == true) // Only show third parties marked for display
                .Select(cp => new ThirdPartyItem
                {
                    Id = cp.CounterPartyId.ToString(),
                    Name = cp.Name ?? string.Empty,
                    CounterPartyNoAlpha = cp.CounterPartyNoAlpha,
                    City = cp.City,
                    Country = cp.Country
                })
                .OrderBy(tp => tp.Name)
                .ToList();

            Logger.LogInformation("âœ… PERF: Prepared {Count} third parties for virtualized selector", allThirdParties.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading third parties");
        }
    }

    private void UpdateLists()
    {
        // Split all third parties into available and selected based on SelectedThirdPartyIds
        selectedItems = allThirdParties
            .Where(tp => SelectedThirdPartyIds.Contains(tp.Id))
            .ToList();

        availableThirdParties = allThirdParties
            .Where(tp => !SelectedThirdPartyIds.Contains(tp.Id))
            .ToList();

        // Apply filter if specified
        if (!string.IsNullOrEmpty(FilterByCounterPartyId))
        {
            // TODO: Filter by relationship to main CounterParty if needed
            // For now, show all
        }

        // Clear search when lists update
        filteredThirdParties.Clear();
        visibleThirdParties.Clear();
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        ApplyFilter();
        showDropdown = true;
        selectedIndex = -1; // Reset selection when typing
        StateHasChanged();
    }

    private void OnSearchFocus()
    {
        showDropdown = true;
    }

    private void OnSearchBlur()
    {
        // Delay hiding dropdown to allow click events to fire
        Task.Delay(200).ContinueWith(_ => InvokeAsync(() =>
        {
            showDropdown = false;
            selectedIndex = -1;
            StateHasChanged();
        }));
    }

    private void ApplyFilter()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            // Don't show all items when search is empty - show hint instead
            filteredThirdParties = new();
            visibleThirdParties = new();
            selectedIndex = -1;
        }
        else
        {
            var term = searchTerm.ToLower().Trim();

            // Filter matching third parties (exclude already selected)
            filteredThirdParties = availableThirdParties
                .Where(tp =>
                    (tp.Name != null && tp.Name.ToLower().Contains(term)) ||
                    (tp.CounterPartyNoAlpha != null && tp.CounterPartyNoAlpha.ToLower().Contains(term)) ||
                    (tp.City != null && tp.City.ToLower().Contains(term)) ||
                    (tp.Country != null && tp.Country.ToLower().Contains(term)))
                .ToList();

            // PERFORMANCE: Only render first MaxVisibleItems (50) to keep DOM small
            visibleThirdParties = filteredThirdParties.Take(MaxVisibleItems).ToList();

            // Auto-select first item when results appear
            if (visibleThirdParties.Any())
            {
                selectedIndex = 0;
            }
            else
            {
                selectedIndex = -1;
            }

            Logger.LogInformation("ðŸ” Filtered to {Filtered} third parties, showing {Visible} in dropdown (first item auto-selected)",
                filteredThirdParties.Count, visibleThirdParties.Count);
        }
    }

    private async Task AddThirdParty(ThirdPartyItem item)
    {
        if (Disabled || SelectedThirdPartyIds.Contains(item.Id))
            return;

        SelectedThirdPartyIds.Add(item.Id);
        SelectedThirdPartyNames.Add(item.Name);

        // Clear search and update lists
        searchTerm = string.Empty;
        showDropdown = false;
        UpdateLists();

        // Notify parent
        await SelectedThirdPartyIdsChanged.InvokeAsync(SelectedThirdPartyIds);
        await SelectedThirdPartyNamesChanged.InvokeAsync(SelectedThirdPartyNames);

        Logger.LogInformation("Added third party {Name}, total selected: {Total}",
            item.Name, SelectedThirdPartyIds.Count);
    }

    private async Task RemoveThirdParty(ThirdPartyItem item)
    {
        if (Disabled)
            return;

        SelectedThirdPartyIds.Remove(item.Id);
        SelectedThirdPartyNames.Remove(item.Name);

        // Update lists
        UpdateLists();

        // Notify parent
        await SelectedThirdPartyIdsChanged.InvokeAsync(SelectedThirdPartyIds);
        await SelectedThirdPartyNamesChanged.InvokeAsync(SelectedThirdPartyNames);

        Logger.LogInformation("Removed third party {Name}, total selected: {Total}",
            item.Name, SelectedThirdPartyIds.Count);
    }

    private MarkupString HighlightMatch(string? text, string searchTerm)
    {
        if (string.IsNullOrEmpty(text) || string.IsNullOrWhiteSpace(searchTerm))
            return new MarkupString(text ?? string.Empty);

        // Simple highlighting - wrap matching text in mark with highlight class
        var pattern = System.Text.RegularExpressions.Regex.Escape(searchTerm);
        var highlighted = System.Text.RegularExpressions.Regex.Replace(
            text,
            pattern,
            match => $"<mark class=\"highlight\">{match.Value}</mark>",
            System.Text.RegularExpressions.RegexOptions.IgnoreCase);

        return new MarkupString(highlighted);
    }

    private async Task OnInputKeyDown(KeyboardEventArgs e)
    {
        // Only log navigation keys to reduce console spam
        if (e.Key == "ArrowDown" || e.Key == "ArrowUp" || e.Key == "Enter" || e.Key == "Escape")
        {
            Logger.LogInformation("ðŸŽ¹ Navigation key: {Key}, Dropdown: {ShowDropdown}, Items: {Count}",
                e.Key, showDropdown, visibleThirdParties.Count);
        }

        // If dropdown not visible, show it on arrow down
        if (!showDropdown && e.Key == "ArrowDown" && !string.IsNullOrWhiteSpace(searchTerm))
        {
            showDropdown = true;
            ApplyFilter();
            selectedIndex = 0; // Select first item
            StateHasChanged();
            Logger.LogInformation("ðŸŽ¹ Dropdown opened with arrow down");
            return;
        }

        // Only handle navigation keys if dropdown is visible with items
        if (!showDropdown || !visibleThirdParties.Any())
        {
            return;
        }

        switch (e.Key)
        {
            case "ArrowDown":
                // Move selection down
                if (selectedIndex < visibleThirdParties.Count - 1)
                {
                    selectedIndex++;
                    Logger.LogInformation("ðŸŽ¹ Selected index: {Index} / {Total}", selectedIndex + 1, visibleThirdParties.Count);
                }
                else
                {
                    Logger.LogInformation("ðŸŽ¹ Already at last item");
                }
                StateHasChanged();
                await ScrollToSelectedItem();
                break;

            case "ArrowUp":
                // Move selection up
                if (selectedIndex > 0)
                {
                    selectedIndex--;
                    Logger.LogInformation("ðŸŽ¹ Selected index: {Index} / {Total}", selectedIndex + 1, visibleThirdParties.Count);
                    StateHasChanged();
                    await ScrollToSelectedItem();
                }
                else if (selectedIndex == 0)
                {
                    // Stay at first item (don't go back to input)
                    Logger.LogInformation("ðŸŽ¹ Already at first item");
                }
                break;

            case "Enter":
                // Select highlighted item if dropdown is visible
                if (showDropdown && selectedIndex >= 0 && selectedIndex < visibleThirdParties.Count)
                {
                    Logger.LogInformation("ðŸŽ¹ Selecting item at index {Index}", selectedIndex);
                    await AddThirdParty(visibleThirdParties[selectedIndex]);
                }
                break;

            case "Escape":
                // Close dropdown
                Logger.LogInformation("ðŸŽ¹ Closing dropdown with Escape");
                showDropdown = false;
                selectedIndex = -1;
                StateHasChanged();
                break;

            case "Tab":
                // Close dropdown and let tab proceed naturally
                Logger.LogInformation("ðŸŽ¹ Closing dropdown with Tab");
                showDropdown = false;
                selectedIndex = -1;
                StateHasChanged();
                break;
        }
    }

    private void OnMouseEnterItem(int index)
    {
        selectedIndex = index;
        StateHasChanged();
    }

    private async Task ScrollToSelectedItem()
    {
        if (selectedIndex >= 0 && selectedIndex < visibleThirdParties.Count)
        {
            try
            {
                // Scroll the selected item into view
                var itemId = $"tp-item-{selectedIndex}";
                await JSRuntime.InvokeVoidAsync("eval",
                    $"document.getElementById('{itemId}')?.scrollIntoView({{ block: 'nearest', behavior: 'smooth' }})");
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to scroll to selected item");
            }
        }
    }
}
