@using IkeaDocuScan_Web.Client.Models
@using IkeaDocuScan.Shared.DTOs.CounterParties
@using IkeaDocuScan.Shared.Interfaces
@inject ICounterPartyService CounterPartyService
@inject ILogger<ThirdPartySelector> Logger

<div class="third-party-selector">
    <div class="row">
        @* Available Third Parties (Left) *@
        <div class="col-5">
            <label class="form-label">Available Third Parties</label>
            <select multiple
                    size="7"
                    class="form-select third-party-listbox"
                    disabled="@Disabled">
                @foreach (var item in availableItems)
                {
                    <option value="@item.Id"
                            selected="@selectedAvailableIds.Contains(item.Id)"
                            @onclick="@(() => ToggleAvailableSelection(item.Id))"
                            @ondblclick="@(() => AddSingleItem(item.Id))">
                        @item.DisplayText
                    </option>
                }
            </select>
            <small class="text-muted">
                @availableItems.Count available | Double-click or use buttons to move
            </small>
        </div>

        @* Add/Remove Buttons (Middle) *@
        <div class="col-2 d-flex flex-column justify-content-center align-items-center">
            <button class="btn btn-primary btn-sm mb-2"
                    @onclick="AddSelectedItems"
                    disabled="@(Disabled || !selectedAvailableIds.Any())"
                    title="Add selected items">
                &raquo;
            </button>
            <button class="btn btn-primary btn-sm"
                    @onclick="RemoveSelectedItems"
                    disabled="@(Disabled || !selectedSelectedIds.Any())"
                    title="Remove selected items">
                &laquo;
            </button>
        </div>

        @* Selected Third Parties (Right) *@
        <div class="col-5">
            <label class="form-label">Selected Third Parties</label>
            <select multiple
                    size="5"
                    class="form-select third-party-listbox"
                    disabled="@Disabled">
                @foreach (var item in selectedItems)
                {
                    <option value="@item.Id"
                            selected="@selectedSelectedIds.Contains(item.Id)"
                            @onclick="@(() => ToggleSelectedSelection(item.Id))"
                            @ondblclick="@(() => RemoveSingleItem(item.Id))">
                        @item.DisplayText
                    </option>
                }
            </select>
            <small class="text-success">
                @selectedItems.Count selected
            </small>
        </div>
    </div>
</div>

<style>
    .third-party-selector {
        width: 100%;
    }

    .third-party-listbox {
        width: 100%;
        font-family: Tahoma, sans-serif;
        font-size: 11px;
        border: solid 1px gray;
    }

    .third-party-listbox option {
        padding: 2px 4px;
        cursor: pointer;
    }

    .third-party-listbox option:hover {
        background-color: #f0f0f0;
    }
</style>

@code {
    /// <summary>
    /// List of selected third party IDs (bound to ViewModel)
    /// </summary>
    [Parameter]
    public List<string> SelectedThirdPartyIds { get; set; } = new();

    /// <summary>
    /// Event callback when selected IDs change
    /// </summary>
    [Parameter]
    public EventCallback<List<string>> SelectedThirdPartyIdsChanged { get; set; }

    /// <summary>
    /// List of selected third party names (bound to ViewModel)
    /// </summary>
    [Parameter]
    public List<string> SelectedThirdPartyNames { get; set; } = new();

    /// <summary>
    /// Event callback when selected names change
    /// </summary>
    [Parameter]
    public EventCallback<List<string>> SelectedThirdPartyNamesChanged { get; set; }

    /// <summary>
    /// Whether the selector is disabled
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Optional filter by CounterPartyId (to show only related third parties)
    /// </summary>
    [Parameter]
    public string? FilterByCounterPartyId { get; set; }

    /// <summary>
    /// Pre-loaded counter parties (optional, passed from parent for performance)
    /// </summary>
    [Parameter]
    public List<CounterPartyDto>? CounterParties { get; set; }

    /// <summary>
    /// Event callback when component finishes loading
    /// </summary>
    [Parameter]
    public EventCallback OnLoadComplete { get; set; }

    // Internal state
    private List<ThirdPartyItem> allThirdParties = new();
    private List<ThirdPartyItem> availableItems = new();
    private List<ThirdPartyItem> selectedItems = new();
    private HashSet<string> selectedAvailableIds = new();
    private HashSet<string> selectedSelectedIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadThirdParties();
        UpdateLists();

        // Signal parent that this component has completed initialization
        await OnLoadComplete.InvokeAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // If SelectedThirdPartyIds changed externally, update our lists
        UpdateLists();
    }

    private async Task LoadThirdParties()
    {
        try
        {
            List<CounterPartyDto> counterParties;

            // Use pre-loaded data if available, otherwise load
            if (CounterParties != null && CounterParties.Any())
            {
                counterParties = CounterParties;
                Logger.LogInformation("Using {Count} pre-loaded counterparties for third party selector", counterParties.Count);
            }
            else
            {
                counterParties = await CounterPartyService.GetAllAsync();
                Logger.LogInformation("Loaded {Count} counterparties for third party selector", counterParties.Count);
            }

            allThirdParties = counterParties
                .Where(cp => cp.DisplayAtCheckIn == true) // Only show third parties marked for display
                .Select(cp => new ThirdPartyItem
                {
                    Id = cp.CounterPartyId.ToString(),
                    Name = cp.Name ?? string.Empty,
                    CounterPartyNoAlpha = cp.CounterPartyNoAlpha,
                    City = cp.City,
                    Country = cp.Country
                })
                .OrderBy(tp => tp.Name)
                .ToList();

            Logger.LogInformation("Prepared {Count} third parties for selector", allThirdParties.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading third parties");
        }
    }

    private void UpdateLists()
    {
        // Split all third parties into available and selected based on SelectedThirdPartyIds
        selectedItems = allThirdParties
            .Where(tp => SelectedThirdPartyIds.Contains(tp.Id))
            .ToList();

        availableItems = allThirdParties
            .Where(tp => !SelectedThirdPartyIds.Contains(tp.Id))
            .ToList();

        // Apply filter if specified
        if (!string.IsNullOrEmpty(FilterByCounterPartyId))
        {
            // TODO: Filter by relationship to main CounterParty if needed
            // For now, show all
        }
    }

    private void ToggleAvailableSelection(string id)
    {
        if (selectedAvailableIds.Contains(id))
            selectedAvailableIds.Remove(id);
        else
            selectedAvailableIds.Add(id);
    }

    private void ToggleSelectedSelection(string id)
    {
        if (selectedSelectedIds.Contains(id))
            selectedSelectedIds.Remove(id);
        else
            selectedSelectedIds.Add(id);
    }

    private async Task AddSingleItem(string id)
    {
        if (Disabled)
            return;

        var item = availableItems.FirstOrDefault(i => i.Id == id);
        if (item != null && !SelectedThirdPartyIds.Contains(item.Id))
        {
            SelectedThirdPartyIds.Add(item.Id);
            SelectedThirdPartyNames.Add(item.Name);

            // Clear selection
            selectedAvailableIds.Remove(id);

            // Update lists
            UpdateLists();

            // Notify parent
            await SelectedThirdPartyIdsChanged.InvokeAsync(SelectedThirdPartyIds);
            await SelectedThirdPartyNamesChanged.InvokeAsync(SelectedThirdPartyNames);

            Logger.LogInformation("Added third party {Name}, total selected: {Total}",
                item.Name, SelectedThirdPartyIds.Count);
        }
    }

    private async Task AddSelectedItems()
    {
        if (Disabled)
            return;

        if (!selectedAvailableIds.Any())
            return;

        // Move selected items from available to selected
        foreach (var id in selectedAvailableIds.ToList())
        {
            var item = availableItems.FirstOrDefault(i => i.Id == id);
            if (item != null)
            {
                SelectedThirdPartyIds.Add(item.Id);
                SelectedThirdPartyNames.Add(item.Name);
            }
        }

        var count = selectedAvailableIds.Count;

        // Clear selection
        selectedAvailableIds.Clear();

        // Update lists
        UpdateLists();

        // Notify parent
        await SelectedThirdPartyIdsChanged.InvokeAsync(SelectedThirdPartyIds);
        await SelectedThirdPartyNamesChanged.InvokeAsync(SelectedThirdPartyNames);

        Logger.LogInformation("Added {Count} third parties, total selected: {Total}",
            count, SelectedThirdPartyIds.Count);
    }

    private async Task RemoveSingleItem(string id)
    {
        if (Disabled)
            return;

        var item = selectedItems.FirstOrDefault(i => i.Id == id);
        if (item != null)
        {
            SelectedThirdPartyIds.Remove(item.Id);
            SelectedThirdPartyNames.Remove(item.Name);

            // Clear selection
            selectedSelectedIds.Remove(id);

            // Update lists
            UpdateLists();

            // Notify parent
            await SelectedThirdPartyIdsChanged.InvokeAsync(SelectedThirdPartyIds);
            await SelectedThirdPartyNamesChanged.InvokeAsync(SelectedThirdPartyNames);

            Logger.LogInformation("Removed third party {Name}, total selected: {Total}",
                item.Name, SelectedThirdPartyIds.Count);
        }
    }

    private async Task RemoveSelectedItems()
    {
        if (Disabled)
            return;

        if (!selectedSelectedIds.Any())
            return;

        var count = selectedSelectedIds.Count;

        // Move selected items from selected back to available
        foreach (var id in selectedSelectedIds.ToList())
        {
            var item = selectedItems.FirstOrDefault(i => i.Id == id);
            if (item != null)
            {
                SelectedThirdPartyIds.Remove(item.Id);
                SelectedThirdPartyNames.Remove(item.Name);
            }
        }

        // Clear selection
        selectedSelectedIds.Clear();

        // Update lists
        UpdateLists();

        // Notify parent
        await SelectedThirdPartyIdsChanged.InvokeAsync(SelectedThirdPartyIds);
        await SelectedThirdPartyNamesChanged.InvokeAsync(SelectedThirdPartyNames);

        Logger.LogInformation("Removed {Count} third parties, total selected: {Total}",
            count, SelectedThirdPartyIds.Count);
    }
}
