@page "/manage-document-names"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using IkeaDocuScan.Shared.DTOs.DocumentNames
@using IkeaDocuScan.Shared.DTOs.DocumentTypes
@using IkeaDocuScan.Shared.Interfaces
@using IkeaDocuScan_Web.Client.Services
@using Microsoft.AspNetCore.Authorization
@inject IDocumentNameService DocumentNameService
@inject IDocumentTypeService DocumentTypeService
@inject EndpointAuthorizationHttpService EndpointAuthService
@inject ILogger<ManageDocumentNames> Logger

<PageTitle>Manage Document Names</PageTitle>

<div class="container-fluid">
    <h3 class="mb-4">
        <i class="bi bi-tags"></i> Manage Document Names
    </h3>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @successMessage
            <button type="button" class="btn-close" @onclick="@(() => successMessage = null)"></button>
        </div>
    }

    @* Document Type Selection *@
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-filter"></i> Select Document Type
            </h5>
        </div>
        <div class="card-body">
            @if (isLoadingTypes)
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading document types...</p>
                </div>
            }
            else
            {
                <div class="row">
                    <div class="col-md-6">
                        <label for="documentTypeSelect" class="form-label">Document Type:</label>
                        <select id="documentTypeSelect"
                                class="form-select"
                                @bind="selectedDocumentTypeId"
                                @bind:after="OnDocumentTypeChanged">
                            <option value="0">-- Select Document Type --</option>
                            @foreach (var type in documentTypes)
                            {
                                var count = documentNameCountByType.GetValueOrDefault(type.DtId, 0);
                                <option value="@type.DtId">@type.DtName@(count > 0 ? $" ({count})" : "")</option>
                            }
                        </select>
                    </div>
                </div>
            }
        </div>
    </div>

    @if (selectedDocumentTypeId > 0)
    {
        @if (hasWriteAccess)
        {
            @* Add New Document Name *@
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-plus-circle"></i> Add New Document Name
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="newDocumentName" class="form-label">Document Name:</label>
                            <input id="newDocumentName"
                                   type="text"
                                   class="form-control"
                                   @bind="newDocumentName"
                                   placeholder="Enter document name"
                                   maxlength="255" />
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-success"
                                    @onclick="AddDocumentName"
                                    disabled="@(string.IsNullOrWhiteSpace(newDocumentName) || isSaving)">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                else
                                {
                                    <i class="bi bi-plus-circle me-2"></i>
                                }
                                Add Document Name
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        @* Document Names List *@
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> Document Names for Selected Type
                    @if (documentNames.Any())
                    {
                        <span class="badge bg-light text-dark ms-2">@documentNames.Count</span>
                    }
                </h5>
            </div>
            <div class="card-body">
                @if (isLoadingNames)
                {
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading document names...</p>
                    </div>
                }
                else if (!documentNames.Any())
                {
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> No document names found for this document type. Add one using the form above.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 100px;">ID</th>
                                    <th>Document Name</th>
                                    <th style="width: 200px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var docName in documentNames)
                                {
                                    <tr>
                                        <td>@docName.Id</td>
                                        <td>
                                            @if (editingDocumentNameId == docName.Id)
                                            {
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       @bind="editingDocumentName"
                                                       maxlength="255" />
                                            }
                                            else
                                            {
                                                @docName.Name
                                            }
                                        </td>
                                        <td>
                                            @if (editingDocumentNameId == docName.Id)
                                            {
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-success"
                                                            @onclick="() => SaveEdit(docName.Id)"
                                                            disabled="@(string.IsNullOrWhiteSpace(editingDocumentName) || isSaving)">
                                                        <i class="bi bi-check"></i> Save
                                                    </button>
                                                    <button class="btn btn-secondary"
                                                            @onclick="CancelEdit"
                                                            disabled="@isSaving">
                                                        <i class="bi bi-x"></i> Cancel
                                                    </button>
                                                </div>
                                            }
                                            else
                                            {
                                                @if (hasWriteAccess)
                                                {
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary"
                                                                @onclick="() => StartEdit(docName)"
                                                                disabled="@(editingDocumentNameId != null || isSaving)">
                                                            <i class="bi bi-pencil"></i> Edit
                                                        </button>
                                                        <button class="btn btn-outline-danger"
                                                                @onclick="() => DeleteDocumentName(docName.Id, docName.Name)"
                                                                disabled="@(editingDocumentNameId != null || isSaving)">
                                                            <i class="bi bi-trash"></i> Delete
                                                        </button>
                                                    </div>
                                                }
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Please select a document type to view and manage its document names.
        </div>
    }
</div>

@* Delete Confirmation Modal *@
<div class="modal fade @(showDeleteConfirmation ? "show d-block" : "")"
     tabindex="-1"
     style="@(showDeleteConfirmation ? "background-color: rgba(0,0,0,0.5);" : "")">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning"></i> Confirm Deletion
                </h5>
                <button type="button" class="btn-close" @onclick="CancelDelete" disabled="@isDeleting"></button>
            </div>
            <div class="modal-body">
                @if (isCheckingUsage)
                {
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Checking...</span>
                        </div>
                        <p class="mt-2">Checking document name usage...</p>
                    </div>
                }
                else if (deleteUsageCount > 0)
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Warning: Document name is in use!</strong>
                        <p class="mb-0 mt-2">
                            Document name <strong>@deleteDocumentName</strong> is currently used by <strong>@deleteUsageCount</strong> document(s).
                        </p>
                        <p class="mb-0 mt-2">
                            You must remove or update all documents using this document name before it can be deleted.
                        </p>
                    </div>
                }
                else
                {
                    <p>Are you sure you want to delete the following document name?</p>
                    <p class="fw-bold">@deleteDocumentName</p>
                    <p class="text-muted mb-0">This action cannot be undone.</p>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CancelDelete" disabled="@isDeleting">
                    Cancel
                </button>
                @if (deleteUsageCount == 0 && !isCheckingUsage)
                {
                    <button class="btn btn-danger" @onclick="ConfirmDelete" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        else
                        {
                            <i class="bi bi-trash me-2"></i>
                        }
                        Delete
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .modal.show {
        display: block;
    }
</style>

@code {
    // Data
    private List<DocumentTypeDto> documentTypes = new();
    private List<DocumentNameDto> documentNames = new();
    private List<DocumentNameDto> allDocumentNames = new();
    private Dictionary<int, int> documentNameCountByType = new();
    private int selectedDocumentTypeId = 0;

    // UI State
    private bool isLoadingTypes = true;
    private bool isLoadingNames = false;
    private bool isSaving = false;
    private bool isDeleting = false;
    private string? errorMessage;
    private string? successMessage;
    private bool hasWriteAccess = false;

    // Add new document name
    private string newDocumentName = string.Empty;

    // Edit document name
    private int? editingDocumentNameId;
    private string editingDocumentName = string.Empty;

    // Delete confirmation
    private bool showDeleteConfirmation = false;
    private int deleteDocumentNameId;
    private string deleteDocumentName = string.Empty;
    private bool isCheckingUsage = false;
    private int deleteUsageCount = 0;

    protected override async Task OnInitializedAsync()
    {
        hasWriteAccess = await EndpointAuthService.CheckAccessAsync("POST", "/api/documentnames/");
        await LoadDocumentTypesAndNames();
    }

    private async Task LoadDocumentTypesAndNames()
    {
        try
        {
            isLoadingTypes = true;
            errorMessage = null;

            Logger.LogInformation("Loading document types and all document names");

            // Load document types and all document names in parallel
            var typesTask = DocumentTypeService.GetAllAsync();
            var namesTask = DocumentNameService.GetAllAsync();

            await Task.WhenAll(typesTask, namesTask);

            documentTypes = await typesTask;
            allDocumentNames = await namesTask;

            // Compute counts by document type
            documentNameCountByType = allDocumentNames
                .Where(dn => dn.DocumentTypeId.HasValue)
                .GroupBy(dn => dn.DocumentTypeId!.Value)
                .ToDictionary(g => g.Key, g => g.Count());

            Logger.LogInformation("Loaded {TypeCount} document types and {NameCount} document names",
                documentTypes.Count, allDocumentNames.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document types and names");
            errorMessage = $"Failed to load data: {ex.Message}";
        }
        finally
        {
            isLoadingTypes = false;
        }
    }

    private async Task OnDocumentTypeChanged()
    {
        Logger.LogInformation("Document type changed to {TypeId}", selectedDocumentTypeId);

        // Reset state
        documentNames.Clear();
        newDocumentName = string.Empty;
        editingDocumentNameId = null;
        editingDocumentName = string.Empty;
        errorMessage = null;
        successMessage = null;

        if (selectedDocumentTypeId > 0)
        {
            await LoadDocumentNames();
        }
    }

    private async Task LoadDocumentNames()
    {
        try
        {
            isLoadingNames = true;
            errorMessage = null;

            Logger.LogInformation("Loading document names for type {TypeId}", selectedDocumentTypeId);
            documentNames = await DocumentNameService.GetByDocumentTypeIdAsync(selectedDocumentTypeId);
            Logger.LogInformation("Loaded {Count} document names", documentNames.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading document names");
            errorMessage = $"Failed to load document names: {ex.Message}";
        }
        finally
        {
            isLoadingNames = false;
        }
    }

    private async Task AddDocumentName()
    {
        if (string.IsNullOrWhiteSpace(newDocumentName))
        {
            return;
        }

        try
        {
            isSaving = true;
            errorMessage = null;
            successMessage = null;

            Logger.LogInformation("Adding new document name: {Name}", newDocumentName);

            var createDto = new CreateDocumentNameDto
            {
                Name = newDocumentName.Trim(),
                DocumentTypeId = selectedDocumentTypeId
            };

            var created = await DocumentNameService.CreateAsync(createDto);
            Logger.LogInformation("Document name created with ID {Id}", created.Id);

            // Reload the list
            await LoadDocumentNames();

            // Update the count in the dropdown
            UpdateDocumentNameCount(selectedDocumentTypeId, 1);

            // Clear input and show success
            newDocumentName = string.Empty;
            successMessage = $"Document name '{created.Name}' added successfully!";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error adding document name");
            errorMessage = $"Failed to add document name: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void StartEdit(DocumentNameDto docName)
    {
        Logger.LogInformation("Starting edit for document name ID {Id}", docName.Id);
        editingDocumentNameId = docName.Id;
        editingDocumentName = docName.Name;
        errorMessage = null;
        successMessage = null;
    }

    private void CancelEdit()
    {
        Logger.LogInformation("Canceling edit");
        editingDocumentNameId = null;
        editingDocumentName = string.Empty;
    }

    private async Task SaveEdit(int id)
    {
        if (string.IsNullOrWhiteSpace(editingDocumentName))
        {
            return;
        }

        try
        {
            isSaving = true;
            errorMessage = null;
            successMessage = null;

            Logger.LogInformation("Saving edit for document name ID {Id}", id);

            var updateDto = new UpdateDocumentNameDto
            {
                Id = id,
                Name = editingDocumentName.Trim(),
                DocumentTypeId = selectedDocumentTypeId
            };

            var updated = await DocumentNameService.UpdateAsync(updateDto);
            Logger.LogInformation("Document name ID {Id} updated successfully", id);

            // Reload the list
            await LoadDocumentNames();

            // Clear edit state and show success
            editingDocumentNameId = null;
            editingDocumentName = string.Empty;
            successMessage = $"Document name updated to '{updated.Name}' successfully!";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating document name");
            errorMessage = $"Failed to update document name: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteDocumentName(int id, string name)
    {
        Logger.LogInformation("Delete requested for document name ID {Id}", id);
        deleteDocumentNameId = id;
        deleteDocumentName = name;
        showDeleteConfirmation = true;
        isCheckingUsage = true;
        deleteUsageCount = 0;
        errorMessage = null;
        successMessage = null;
        StateHasChanged();

        try
        {
            deleteUsageCount = await DocumentNameService.GetUsageCountAsync(id);
            Logger.LogInformation("Document name ID {Id} is used by {Count} documents", id, deleteUsageCount);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking document name usage");
            errorMessage = $"Error checking document name usage: {ex.Message}";
        }
        finally
        {
            isCheckingUsage = false;
            StateHasChanged();
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
        deleteDocumentNameId = 0;
        deleteDocumentName = string.Empty;
        deleteUsageCount = 0;
    }

    /// <summary>
    /// Updates the document name count for a document type in the dropdown
    /// </summary>
    private void UpdateDocumentNameCount(int documentTypeId, int delta)
    {
        if (documentNameCountByType.ContainsKey(documentTypeId))
        {
            documentNameCountByType[documentTypeId] += delta;
            if (documentNameCountByType[documentTypeId] <= 0)
            {
                documentNameCountByType.Remove(documentTypeId);
            }
        }
        else if (delta > 0)
        {
            documentNameCountByType[documentTypeId] = delta;
        }
    }

    private async Task ConfirmDelete()
    {
        try
        {
            isDeleting = true;
            errorMessage = null;
            successMessage = null;

            Logger.LogInformation("Deleting document name ID {Id}", deleteDocumentNameId);

            await DocumentNameService.DeleteAsync(deleteDocumentNameId);
            Logger.LogInformation("Document name ID {Id} deleted successfully", deleteDocumentNameId);

            // Close modal
            showDeleteConfirmation = false;

            // Reload the list
            await LoadDocumentNames();

            // Update the count in the dropdown
            UpdateDocumentNameCount(selectedDocumentTypeId, -1);

            // Show success
            successMessage = $"Document name '{deleteDocumentName}' deleted successfully!";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting document name");
            errorMessage = $"Failed to delete document name: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }
}
