@page "/edit-userpermissions"
@rendermode InteractiveAuto
@attribute [Authorize(Policy = "HasAccess")]
@using IkeaDocuScan.Shared.DTOs.UserPermissions
@using IkeaDocuScan.Shared.DTOs.DocumentTypes
@using IkeaDocuScan.Shared.Interfaces
@using IkeaDocuScan_Web.Client.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@inject IUserPermissionService UserPermissionService
@inject IDocumentTypeService DocumentTypeService
@inject EndpointAuthorizationHttpService EndpointAuthService
@inject IJSRuntime JSRuntime
@inject ILogger<EditUserPermissions> Logger
@implements IDisposable

<PageTitle>Edit User Permissions</PageTitle>

<div class="container-fluid mt-4">
    <h1>User Permissions Management</h1>
    <p class="text-muted">Manage user permissions for Document Types</p>

    @if (selectedUser == null)
    {
        <!-- User List View -->
        <div @key="@("user-list-view")" class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Search Users</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="searchInput" class="form-label">Search by Account Name</label>
                    <input
                        type="text"
                        class="form-control"
                        id="searchInput"
                        placeholder="Type at least @MinSearchLength characters to search..."
                        value="@searchTerm"
                        @oninput="OnSearchTermChanged" />
                    <small class="form-text text-muted">
                        @if (searchTerm.Length > 0 && searchTerm.Length < MinSearchLength)
                        {
                            <span class="text-warning">Type at least @MinSearchLength characters to search...</span>
                        }
                        else
                        {
                            <span>Filters by user account name. Leave empty to show all users.</span>
                        }
                    </small>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="filterNoPermissions"
                           @bind="showOnlyUsersWithoutPermissions">
                    <label class="form-check-label" for="filterNoPermissions">
                        <i class="fa fa-filter"></i> Show only users without permissions (registration requests)
                    </label>
                </div>
            </div>
        </div>

        @if (hasWriteAccess)
        {
            <div class="mt-3 mb-3">
                <button class="btn btn-primary" @onclick="ShowAddUserForm">
                    <i class="fa fa-user-plus"></i> Add New User
                </button>
            </div>
        }

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    DocuScan Users
                    @if (showOnlyUsersWithoutPermissions)
                    {
                        <span class="badge bg-warning text-dark">@(FilteredUsers?.Count ?? 0) without permissions</span>
                        <span class="text-muted small">(of @(users?.Count ?? 0) total)</span>
                    }
                    else
                    {
                        <span>(@(FilteredUsers?.Count ?? 0))</span>
                    }
                </h5>
            </div>
            <div class="card-body">
                @if (isLoading)
                {
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading users...</p>
                    </div>
                }
                else if (errorMessage != null)
                {
                    <div class="alert alert-danger">
                        @errorMessage
                    </div>
                }
                else if (FilteredUsers != null && FilteredUsers.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>User ID</th>
                                    <th>Account Name</th>
                                    <th>Last Logon</th>
                                    <th>Super User</th>
                                    <th>Permissions</th>
                                    <th style="width: 150px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in FilteredUsers)
                                {
                                    <tr style="cursor: pointer;" @onclick="() => SelectUser(user)">
                                        <td>@user.UserId</td>
                                        <td><strong>@user.AccountName</strong></td>
                                        <td>@(user.LastLogon?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                                        <td>
                                            @if (user.IsSuperUser)
                                            {
                                                <span class="badge bg-success">Yes</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">No</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-info">@user.PermissionCount</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" @onclick="() => SelectUser(user)" @onclick:stopPropagation="true">
                                                <i class="fa fa-edit"></i> Manage
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        @if (showOnlyUsersWithoutPermissions)
                        {
                            <span>No users without permissions found. All users have been assigned permissions.</span>
                        }
                        else
                        {
                            <span>No users found. @(string.IsNullOrWhiteSpace(searchTerm) ? "" : "Try a different search term.")</span>
                        }
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <!-- User Permissions Detail View -->
        <div @key="@($"user-detail-view-{selectedUser.UserId}")" class="card mt-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Permissions for @selectedUser.AccountName</h5>
                    <button class="btn btn-sm btn-light" @onclick="BackToUserList">
                        <i class="fa fa-arrow-left"></i> Back to Users
                    </button>
                </div>
            </div>
            <div class="card-body">
                @if (saveErrorMessage != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @saveErrorMessage
                        <button type="button" class="btn-close" @onclick="() => saveErrorMessage = null"></button>
                    </div>
                }

                @if (saveSuccessMessage != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @saveSuccessMessage
                        <button type="button" class="btn-close" @onclick="() => saveSuccessMessage = null"></button>
                    </div>
                }

                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>User ID:</strong> @selectedUser.UserId
                    </div>
                    <div class="col-md-4">
                        <strong>Account Name:</strong> @selectedUser.AccountName
                    </div>
                    <div class="col-md-4">
                        <strong>Super User:</strong> @(selectedUser.IsSuperUser ? "Yes" : "No")
                    </div>
                </div>

                @if (hasWriteAccess)
                {
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fa fa-info-circle"></i> <strong>User Management:</strong> Delete this user and all their permissions
                        </div>
                        <button type="button" class="btn btn-danger" @onclick="InitiateDeleteUser">
                            <i class="fa fa-user-times"></i> Delete User
                        </button>
                    </div>
                }

                <hr />

                @if (!showPermissionForm)
                {
                    <!-- Permissions List -->
                    @if (hasWriteAccess)
                    {
                        <div class="mb-3">
                            <button class="btn btn-primary me-2" @onclick="ShowBatchDocumentTypeModal">
                                <i class="fa fa-list-check"></i> Batch Edit Document Types
                            </button>
                            <button class="btn btn-success" @onclick="GrantAllDocumentTypesAccess">
                                <i class="fa fa-unlock"></i> Grant All Document Types Access
                            </button>
                        </div>
                    }

                    @if (isLoadingPermissions)
                    {
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading permissions...</p>
                        </div>
                    }
                    else if (permissions != null && permissions.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Document Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var permission in permissions)
                                    {
                                        <tr>
                                            <td>@permission.Id</td>
                                            <td>@(permission.DocumentTypeName ?? "-")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            This user has no permissions yet. Click "Batch Edit Document Types" to assign permissions.
                        </div>
                    }
                }
                else
                {
                    <!-- Permission Form (Add/Edit) -->
                    <div class="card border-secondary">
                        <div class="card-header">
                            <h6 class="mb-0">@(editingPermission == null ? "Add New Permission" : $"Edit Permission #{editingPermission.Id}")</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <DocumentTypeSelect
                                        Label="Document Type"
                                        SelectedDocumentTypeId="@selectedDocumentTypeId"
                                        SelectedDocumentTypeIdChanged="@OnDocumentTypeSelected" />
                                </div>
                            </div>

                            <div class="mt-4">
                                <button class="btn btn-success me-2" @onclick="SavePermission" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="fa fa-save"></i> @(editingPermission == null ? "Add Permission" : "Save Changes")
                                </button>
                                <button class="btn btn-secondary" @onclick="CancelPermissionForm" disabled="@isSaving">
                                    <i class="fa fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    @* Delete Confirmation Modal *@
    @if (showDeleteConfirmation && permissionToDelete != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fa fa-exclamation-triangle"></i> Confirm Delete
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelDelete"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Are you sure you want to delete this permission?</strong></p>
                        <div class="alert alert-warning">
                            <p class="mb-2"><strong>Permission Details:</strong></p>
                            <ul class="mb-0">
                                <li><strong>ID:</strong> @permissionToDelete.Id</li>
                                <li><strong>User:</strong> @permissionToDelete.AccountName</li>
                                @if (!string.IsNullOrEmpty(permissionToDelete.DocumentTypeName))
                                {
                                    <li><strong>Document Type:</strong> @permissionToDelete.DocumentTypeName</li>
                                }
                            </ul>
                        </div>
                        <p class="text-danger mb-0">
                            <i class="fa fa-warning"></i> This action cannot be undone.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelDelete">
                            <i class="fa fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteAction">
                            <i class="fa fa-trash"></i> Delete Permission
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Delete User Confirmation Modal *@
    @if (showDeleteUserConfirmation && userToDelete != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fa fa-exclamation-triangle"></i> Confirm Delete User
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelDeleteUser"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <h5><i class="fa fa-warning"></i> WARNING: This action is IRREVERSIBLE!</h5>
                            <p class="mb-0">You are about to permanently delete this user and ALL their permissions.</p>
                        </div>

                        <p><strong>User to be deleted:</strong></p>
                        <div class="card mb-3">
                            <div class="card-body">
                                <ul class="mb-0">
                                    <li><strong>User ID:</strong> @userToDelete.UserId</li>
                                    <li><strong>Account Name:</strong> @userToDelete.AccountName</li>
                                    <li><strong>Super User:</strong> @(userToDelete.IsSuperUser ? "Yes" : "No")</li>
                                    <li><strong>Total Permissions:</strong> @userToDelete.PermissionCount</li>
                                </ul>
                            </div>
                        </div>

                        <div class="alert alert-warning">
                            <p class="mb-2"><strong>The following will be deleted:</strong></p>
                            <ul class="mb-0">
                                <li>The user account (@userToDelete.AccountName)</li>
                                <li>All @userToDelete.PermissionCount permission(s) assigned to this user</li>
                            </ul>
                        </div>

                        <p class="text-danger">
                            <i class="fa fa-exclamation-circle"></i> <strong>This action cannot be undone!</strong>
                        </p>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmDeleteCheck" @bind="deleteUserConfirmed">
                            <label class="form-check-label" for="confirmDeleteCheck">
                                <strong>I understand this action is permanent and cannot be undone</strong>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelDeleteUser">
                            <i class="fa fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="ConfirmDeleteUserAction" disabled="@(!deleteUserConfirmed)">
                            <i class="fa fa-user-times"></i> Delete User & All Permissions
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Add/Edit User Modal *@
    @if (showUserFormModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fa @(editingUser == null ? "fa-user-plus" : "fa-user-edit")"></i> @(editingUser == null ? "Add New User" : $"Edit User: {editingUser.AccountName}")
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelUserForm"></button>
                    </div>
                    <div class="modal-body">
                        @if (userFormErrorMessage != null)
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                @userFormErrorMessage
                                <button type="button" class="btn-close" @onclick="() => userFormErrorMessage = null"></button>
                            </div>
                        }

                        <div class="mb-3">
                            <label for="accountName" class="form-label">
                                Account Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="accountName"
                                   placeholder="e.g., DOMAIN\username or username@domain.com"
                                   @bind="newUserAccountName" />
                            <div class="form-text">
                                The Windows account name or email address for the user
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isSuperUser" @bind="newUserIsSuperUser">
                            <label class="form-check-label" for="isSuperUser">
                                <strong>Super User</strong>
                            </label>
                            <div class="form-text">
                                Super users have full access to all features including configuration management
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"></i> <strong>Note:</strong> After creating the user, you can add specific permissions for Document Types.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelUserForm" disabled="@isSavingUser">
                            <i class="fa fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-success" @onclick="SaveUser" disabled="@isSavingUser">
                            @if (isSavingUser)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <i class="fa fa-save"></i> @(editingUser == null ? "Create User" : "Save Changes")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Batch Document Type Modal *@
    @if (showBatchDocTypeModal && selectedUser != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg" style="max-width: 900px;">
                <div class="modal-content" style="resize: both; overflow: auto; min-height: 600px;">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fa fa-list-check"></i> Batch Edit Document Types for @selectedUser.AccountName
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CloseBatchDocTypeModal"></button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        @if (batchModalErrorMessage != null)
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                @batchModalErrorMessage
                                <button type="button" class="btn-close" @onclick="() => batchModalErrorMessage = null"></button>
                            </div>
                        }

                        @if (batchModalSuccessMessage != null)
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                @batchModalSuccessMessage
                                <button type="button" class="btn-close" @onclick="() => batchModalSuccessMessage = null"></button>
                            </div>
                        }

                        <!-- Copy from another user section -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fa fa-copy"></i> Copy Privileges from Another User</h6>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-end">
                                    <div class="col-md-6">
                                        <label class="form-label">Search User</label>
                                        <input type="text" class="form-control" placeholder="Type account name to search..."
                                               @bind="copyFromUserSearch" @bind:event="oninput" />
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-primary w-100" @onclick="SearchUserToCopyFrom" disabled="@(string.IsNullOrWhiteSpace(copyFromUserSearch) || copyFromUserSearch.Length < 3)">
                                            <i class="fa fa-search"></i> Search
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        @if (selectedSourceUser != null)
                                        {
                                            <button class="btn btn-success w-100" @onclick="ApplyCopyFromSelectedUser">
                                                <i class="fa fa-copy"></i> Copy Privileges
                                            </button>
                                        }
                                    </div>
                                </div>
                                @if (copyFromUserResults != null && copyFromUserResults.Any())
                                {
                                    <div class="mt-3">
                                        <label class="form-label">Select User to Copy From:</label>
                                        <div class="list-group" style="max-height: 180px; overflow-y: auto;">
                                            @foreach (var user in copyFromUserResults)
                                            {
                                                var isSelected = selectedSourceUser?.UserId == user.UserId;
                                                <button type="button"
                                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(isSelected ? "active" : "")"
                                                        @onclick="() => SelectSourceUser(user)">
                                                    <div>
                                                        @if (isSelected)
                                                        {
                                                            <i class="fa fa-check-circle me-2"></i>
                                                        }
                                                        <span>@user.AccountName</span>
                                                    </div>
                                                    <span class="badge @(isSelected ? "bg-light text-dark" : "bg-info")">@user.PermissionCount permissions</span>
                                                </button>
                                            }
                                        </div>
                                        @if (selectedSourceUser != null)
                                        {
                                            <div class="alert alert-info mt-2 mb-0 d-flex justify-content-between align-items-center">
                                                <span><i class="fa fa-info-circle"></i> Selected: <strong>@selectedSourceUser.AccountName</strong> (@selectedSourceUser.PermissionCount permissions)</span>
                                                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearSelectedSourceUser">
                                                    <i class="fa fa-times"></i> Clear
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                                else if (copyFromUserSearched && copyFromUserResults != null)
                                {
                                    <div class="alert alert-warning mt-2 mb-0">No users found matching your search.</div>
                                }
                            </div>
                        </div>

                        <!-- Document Types Dual List -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fa fa-file-alt"></i> Document Types Selection
                                    <span class="badge bg-primary ms-2">@(selectedDocTypeIds?.Count ?? 0) selected</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                @if (isLoadingDocTypes)
                                {
                                    <div class="text-center p-3">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Loading document types...</span>
                                    </div>
                                }
                                else if (allDocumentTypes != null && allDocumentTypes.Any())
                                {
                                    <div class="row">
                                        <!-- Available Document Types -->
                                        <div class="col-md-5">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label mb-0"><strong>Available</strong></label>
                                                <small class="text-muted">@GetAvailableDocTypes().Count items</small>
                                            </div>
                                            <select @ref="availableSelectElement" multiple class="form-select" style="height: 300px; font-size: 0.9rem;"
                                                    size="15">
                                                @foreach (var docType in GetAvailableDocTypes().OrderBy(d => d.DtName))
                                                {
                                                    <option value="@docType.DtId">@docType.DtName</option>
                                                }
                                            </select>
                                        </div>

                                        <!-- Move Buttons -->
                                        <div class="col-md-2 d-flex flex-column justify-content-center align-items-center gap-2">
                                            <button class="btn btn-primary btn-sm" style="width: 100px;" @onclick="MoveAllToSelected" title="Select all">
                                                <i class="fa fa-angle-double-right"></i>
                                            </button>
                                            <button class="btn btn-primary btn-sm" style="width: 100px;" @onclick="MoveToSelected" title="Select highlighted">
                                                <i class="fa fa-angle-right"></i>
                                            </button>
                                            <button class="btn btn-secondary btn-sm" style="width: 100px;" @onclick="MoveToAvailable" title="Deselect highlighted">
                                                <i class="fa fa-angle-left"></i>
                                            </button>
                                            <button class="btn btn-secondary btn-sm" style="width: 100px;" @onclick="MoveAllToAvailable" title="Deselect all">
                                                <i class="fa fa-angle-double-left"></i>
                                            </button>
                                        </div>

                                        <!-- Selected Document Types -->
                                        <div class="col-md-5">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label mb-0"><strong>Selected</strong></label>
                                                <small class="text-muted">@GetSelectedDocTypes().Count items</small>
                                            </div>
                                            <select @ref="selectedSelectElement" multiple class="form-select" style="height: 300px; font-size: 0.9rem;"
                                                    size="15">
                                                @foreach (var docType in GetSelectedDocTypes().OrderBy(d => d.DtName))
                                                {
                                                    <option value="@docType.DtId">@docType.DtName</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info mb-0">No document types available.</div>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseBatchDocTypeModal" disabled="@isSavingBatch">
                            <i class="fa fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="ApplyBatchDocumentTypes" disabled="@isSavingBatch">
                            @if (isSavingBatch)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <i class="fa fa-save"></i> Apply Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public int MinSearchLength { get; set; } = 3;

    // User list
    private List<DocuScanUserDto>? users;
    private DocuScanUserDto? selectedUser;

    // Filtered users based on search and permission filter
    private List<DocuScanUserDto>? FilteredUsers
    {
        get
        {
            if (users == null) return null;

            var filtered = users.AsEnumerable();

            // Apply permission count filter
            if (showOnlyUsersWithoutPermissions)
            {
                filtered = filtered.Where(u => u.PermissionCount == 0);
            }

            return filtered.ToList();
        }
    }

    // Permissions for selected user
    private List<UserPermissionDto>? permissions;
    private UserPermissionDto? editingPermission;

    // UI state
    private bool showPermissionForm = false;
    private bool isLoading = false;
    private bool isLoadingPermissions = false;
    private bool isSaving = false;

    // Delete confirmation
    private bool showDeleteConfirmation = false;
    private UserPermissionDto? permissionToDelete = null;
    private TaskCompletionSource<bool>? deleteConfirmationTcs = null;

    // Delete user confirmation
    private bool showDeleteUserConfirmation = false;
    private DocuScanUserDto? userToDelete = null;
    private bool deleteUserConfirmed = false;
    private TaskCompletionSource<bool>? deleteUserConfirmationTcs = null;

    // Messages
    private string? errorMessage = null;
    private string? saveErrorMessage = null;
    private string? saveSuccessMessage = null;

    // Write access
    private bool hasWriteAccess = false;

    // Search
    private string searchTerm = string.Empty;
    private Timer? _debounceTimer;
    private const int DebounceDelayMs = 500;
    private bool showOnlyUsersWithoutPermissions = false;

    // Edit form values
    private int? selectedDocumentTypeId;

    // User form
    private bool showUserFormModal = false;
    private bool isSavingUser = false;
    private DocuScanUserDto? editingUser = null;
    private string newUserAccountName = string.Empty;
    private bool newUserIsSuperUser = false;
    private string? userFormErrorMessage = null;

    // Batch document type modal
    private bool showBatchDocTypeModal = false;
    private bool isLoadingDocTypes = false;
    private bool isSavingBatch = false;
    private List<DocumentTypeDto>? allDocumentTypes;
    private HashSet<int> selectedDocTypeIds = new();
    private string? batchModalErrorMessage = null;
    private string? batchModalSuccessMessage = null;
    private string copyFromUserSearch = string.Empty;
    private List<DocuScanUserDto>? copyFromUserResults;
    private bool copyFromUserSearched = false;
    private DocuScanUserDto? selectedSourceUser = null;

    // Element references for multi-select lists
    private ElementReference availableSelectElement;
    private ElementReference selectedSelectElement;

    protected override async Task OnInitializedAsync()
    {
        hasWriteAccess = await EndpointAuthService.CheckAccessAsync("POST", "/api/userpermissions/");
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            Logger.LogInformation("Loading DocuScan users");
            var filter = string.IsNullOrWhiteSpace(searchTerm) || searchTerm.Length < MinSearchLength
                ? null
                : searchTerm;

            users = await UserPermissionService.GetAllUsersAsync(filter);
            Logger.LogInformation("Loaded {Count} users", users.Count);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading users: {ex.Message}";
            Logger.LogError(ex, "Error loading users");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnSearchTermChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;

        // Cancel previous timer
        _debounceTimer?.Dispose();

        // Start new debounce timer
        _debounceTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadUsers();
                StateHasChanged();
            });
        }, null, DebounceDelayMs, Timeout.Infinite);
    }

    private async Task SelectUser(DocuScanUserDto user)
    {
        selectedUser = user;
        permissions = null;
        showPermissionForm = false;
        editingPermission = null;
        saveErrorMessage = null;
        saveSuccessMessage = null;
        ClearFormFields();
        StateHasChanged();
        await LoadUserPermissions();
    }

    private void BackToUserList()
    {
        selectedUser = null;
        permissions = null;
        showPermissionForm = false;
        editingPermission = null;
        ClearFormFields();
        StateHasChanged();
    }

    private async Task LoadUserPermissions()
    {
        if (selectedUser == null) return;

        isLoadingPermissions = true;
        saveErrorMessage = null;

        try
        {
            Logger.LogInformation("Loading permissions for user {UserId}", selectedUser.UserId);
            permissions = await UserPermissionService.GetByUserIdAsync(selectedUser.UserId);
            Logger.LogInformation("Loaded {Count} permissions for user {UserId}", permissions.Count, selectedUser.UserId);
        }
        catch (Exception ex)
        {
            saveErrorMessage = $"Error loading permissions: {ex.Message}";
            Logger.LogError(ex, "Error loading permissions for user {UserId}", selectedUser.UserId);
        }
        finally
        {
            isLoadingPermissions = false;
        }
    }

    private void ShowAddPermissionForm()
    {
        editingPermission = null;
        ClearFormFields();
        showPermissionForm = true;
        saveErrorMessage = null;
        saveSuccessMessage = null;
    }

    private void EditPermission(UserPermissionDto permission)
    {
        editingPermission = permission;
        selectedDocumentTypeId = permission.DocumentTypeId;

        showPermissionForm = true;
        saveErrorMessage = null;
        saveSuccessMessage = null;
    }

    private void CancelPermissionForm()
    {
        showPermissionForm = false;
        editingPermission = null;
        ClearFormFields();
    }

    private void ClearFormFields()
    {
        selectedDocumentTypeId = null;
    }

    private async Task SavePermission()
    {
        if (selectedUser == null) return;

        isSaving = true;
        saveErrorMessage = null;
        saveSuccessMessage = null;

        try
        {
            if (editingPermission == null)
            {
                // Add new permission
                Logger.LogInformation("Creating new permission for user {UserId}", selectedUser.UserId);

                var createDto = new CreateUserPermissionDto
                {
                    UserId = selectedUser.UserId,
                    DocumentTypeId = selectedDocumentTypeId
                };

                await UserPermissionService.CreateAsync(createDto);
                saveSuccessMessage = "Permission added successfully!";
                Logger.LogInformation("Permission created successfully for user {UserId}", selectedUser.UserId);
            }
            else
            {
                // Update existing permission
                Logger.LogInformation("Updating permission {Id}", editingPermission.Id);

                var updateDto = new UpdateUserPermissionDto
                {
                    Id = editingPermission.Id,
                    DocumentTypeId = selectedDocumentTypeId
                };

                await UserPermissionService.UpdateAsync(updateDto);
                saveSuccessMessage = "Permission updated successfully!";
                Logger.LogInformation("Permission {Id} updated successfully", editingPermission.Id);
            }

            // Reload permissions list and update user count
            await LoadUserPermissions();
            await LoadUsers();

            // Close form
            showPermissionForm = false;
            editingPermission = null;
            ClearFormFields();
        }
        catch (Exception ex)
        {
            saveErrorMessage = $"Error saving permission: {ex.Message}";
            Logger.LogError(ex, "Error saving permission");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeletePermission(UserPermissionDto permission)
    {
        if (!await ConfirmDelete(permission)) return;

        saveErrorMessage = null;
        saveSuccessMessage = null;

        try
        {
            Logger.LogInformation("Deleting permission {Id}", permission.Id);
            await UserPermissionService.DeleteAsync(permission.Id);
            saveSuccessMessage = "Permission deleted successfully!";

            // Reload permissions list and update user count
            await LoadUserPermissions();
            await LoadUsers();
        }
        catch (Exception ex)
        {
            saveErrorMessage = $"Error deleting permission: {ex.Message}";
            Logger.LogError(ex, "Error deleting permission {Id}", permission.Id);
        }
    }

    private async Task<bool> ConfirmDelete(UserPermissionDto permission)
    {
        permissionToDelete = permission;
        showDeleteConfirmation = true;
        deleteConfirmationTcs = new TaskCompletionSource<bool>();

        StateHasChanged();

        return await deleteConfirmationTcs.Task;
    }

    private void ConfirmDeleteAction()
    {
        showDeleteConfirmation = false;
        deleteConfirmationTcs?.SetResult(true);
        permissionToDelete = null;
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
        deleteConfirmationTcs?.SetResult(false);
        permissionToDelete = null;
    }

    private async Task InitiateDeleteUser()
    {
        if (selectedUser == null) return;

        userToDelete = selectedUser;
        showDeleteUserConfirmation = true;
        deleteUserConfirmed = false;
        deleteUserConfirmationTcs = new TaskCompletionSource<bool>();

        StateHasChanged();

        var confirmed = await deleteUserConfirmationTcs.Task;

        if (confirmed)
        {
            await ExecuteDeleteUser();
        }
    }

    private async Task ExecuteDeleteUser()
    {
        if (userToDelete == null) return;

        saveErrorMessage = null;
        saveSuccessMessage = null;

        try
        {
            Logger.LogInformation("Deleting user {UserId} and all permissions", userToDelete.UserId);
            await UserPermissionService.DeleteUserAsync(userToDelete.UserId);

            saveSuccessMessage = $"User '{userToDelete.AccountName}' and all their permissions have been deleted successfully!";
            Logger.LogInformation("User {UserId} deleted successfully", userToDelete.UserId);

            // Wait a moment to show success message
            await Task.Delay(1500);

            // Go back to user list and reload
            selectedUser = null;
            userToDelete = null;
            await LoadUsers();
        }
        catch (Exception ex)
        {
            saveErrorMessage = $"Error deleting user: {ex.Message}";
            Logger.LogError(ex, "Error deleting user {UserId}", userToDelete?.UserId);
        }
    }

    private void ConfirmDeleteUserAction()
    {
        showDeleteUserConfirmation = false;
        deleteUserConfirmationTcs?.SetResult(true);
    }

    private void CancelDeleteUser()
    {
        showDeleteUserConfirmation = false;
        deleteUserConfirmationTcs?.SetResult(false);
        userToDelete = null;
        deleteUserConfirmed = false;
    }

    private void OnDocumentTypeSelected(int? documentTypeId)
    {
        selectedDocumentTypeId = documentTypeId;
    }

    private void ShowAddUserForm()
    {
        editingUser = null;
        newUserAccountName = string.Empty;
        newUserIsSuperUser = false;
        userFormErrorMessage = null;
        showUserFormModal = true;
    }

    private void CancelUserForm()
    {
        showUserFormModal = false;
        editingUser = null;
        newUserAccountName = string.Empty;
        newUserIsSuperUser = false;
        userFormErrorMessage = null;
    }

    private async Task SaveUser()
    {
        if (string.IsNullOrWhiteSpace(newUserAccountName))
        {
            userFormErrorMessage = "Account Name is required";
            return;
        }

        isSavingUser = true;
        userFormErrorMessage = null;

        try
        {
            if (editingUser == null)
            {
                // Create new user
                Logger.LogInformation("Creating new user: {AccountName}", newUserAccountName);

                var createDto = new CreateDocuScanUserDto
                {
                    AccountName = newUserAccountName.Trim(),
                    IsSuperUser = newUserIsSuperUser
                };

                var created = await UserPermissionService.CreateUserAsync(createDto);
                Logger.LogInformation("User created with ID: {UserId}", created.UserId);

                // Reload users list
                await LoadUsers();

                // Show success message
                saveSuccessMessage = $"User '{created.AccountName}' created successfully!";

                // Close modal
                showUserFormModal = false;
                ClearUserForm();
            }
            else
            {
                // Update existing user
                Logger.LogInformation("Updating user ID: {UserId}", editingUser.UserId);

                var updateDto = new UpdateDocuScanUserDto
                {
                    UserId = editingUser.UserId,
                    AccountName = newUserAccountName.Trim(),
                    IsSuperUser = newUserIsSuperUser
                };

                var updated = await UserPermissionService.UpdateUserAsync(updateDto);
                Logger.LogInformation("User ID {UserId} updated successfully", updated.UserId);

                // Reload users list
                await LoadUsers();

                // Show success message
                saveSuccessMessage = $"User '{updated.AccountName}' updated successfully!";

                // Close modal
                showUserFormModal = false;
                ClearUserForm();
            }
        }
        catch (Exception ex)
        {
            userFormErrorMessage = $"Error saving user: {ex.Message}";
            Logger.LogError(ex, "Error saving user");
        }
        finally
        {
            isSavingUser = false;
        }
    }

    private void ClearUserForm()
    {
        editingUser = null;
        newUserAccountName = string.Empty;
        newUserIsSuperUser = false;
        userFormErrorMessage = null;
    }

    // ========================================
    // Batch Document Type Modal Methods
    // ========================================

    // Helper methods to get available and selected document types
    private List<DocumentTypeDto> GetAvailableDocTypes()
    {
        if (allDocumentTypes == null) return new List<DocumentTypeDto>();
        return allDocumentTypes.Where(dt => !selectedDocTypeIds.Contains(dt.DtId)).ToList();
    }

    private List<DocumentTypeDto> GetSelectedDocTypes()
    {
        if (allDocumentTypes == null) return new List<DocumentTypeDto>();
        return allDocumentTypes.Where(dt => selectedDocTypeIds.Contains(dt.DtId)).ToList();
    }

    // Move methods for dual list
    private async Task MoveToSelected()
    {
        try
        {
            // Use JavaScript to get selected option values from the available list
            var selectedIds = await JSRuntime.InvokeAsync<int[]>("getSelectedOptions", availableSelectElement);

            if (selectedIds == null || selectedIds.Length == 0) return;

            var newSet = new HashSet<int>(selectedDocTypeIds);
            foreach (var id in selectedIds)
            {
                newSet.Add(id);
            }
            selectedDocTypeIds = newSet;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error moving items to selected list");
        }
    }

    private async Task MoveToAvailable()
    {
        try
        {
            // Use JavaScript to get selected option values from the selected list
            var selectedIds = await JSRuntime.InvokeAsync<int[]>("getSelectedOptions", selectedSelectElement);

            if (selectedIds == null || selectedIds.Length == 0) return;

            var newSet = new HashSet<int>(selectedDocTypeIds);
            foreach (var id in selectedIds)
            {
                newSet.Remove(id);
            }
            selectedDocTypeIds = newSet;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error moving items to available list");
        }
    }

    private void MoveAllToSelected()
    {
        if (allDocumentTypes == null) return;
        selectedDocTypeIds = allDocumentTypes.Select(dt => dt.DtId).ToHashSet();
    }

    private void MoveAllToAvailable()
    {
        selectedDocTypeIds = new HashSet<int>();
    }

    private async Task ShowBatchDocumentTypeModal()
    {
        if (selectedUser == null) return;

        showBatchDocTypeModal = true;
        isLoadingDocTypes = true;
        batchModalErrorMessage = null;
        batchModalSuccessMessage = null;
        copyFromUserSearch = string.Empty;
        copyFromUserResults = null;
        copyFromUserSearched = false;

        try
        {
            // Load all document types
            allDocumentTypes = await DocumentTypeService.GetAllAsync();

            // Preselect based on current user's permissions
            selectedDocTypeIds = permissions?
                .Where(p => p.DocumentTypeId.HasValue)
                .Select(p => p.DocumentTypeId!.Value)
                .ToHashSet() ?? new HashSet<int>();

            Logger.LogInformation("Loaded {Count} document types, user has {Selected} selected",
                allDocumentTypes.Count, selectedDocTypeIds.Count);
        }
        catch (Exception ex)
        {
            batchModalErrorMessage = $"Error loading document types: {ex.Message}";
            Logger.LogError(ex, "Error loading document types for batch modal");
        }
        finally
        {
            isLoadingDocTypes = false;
        }
    }

    private void CloseBatchDocTypeModal()
    {
        showBatchDocTypeModal = false;
        allDocumentTypes = null;
        selectedDocTypeIds = new HashSet<int>();
        copyFromUserSearch = string.Empty;
        copyFromUserResults = null;
        copyFromUserSearched = false;
        selectedSourceUser = null;
        batchModalErrorMessage = null;
        batchModalSuccessMessage = null;
    }

    private void OnDocTypeCheckChanged(int docTypeId, bool isChecked)
    {
        var newSet = new HashSet<int>(selectedDocTypeIds);
        if (isChecked)
        {
            newSet.Add(docTypeId);
        }
        else
        {
            newSet.Remove(docTypeId);
        }
        selectedDocTypeIds = newSet;
    }

    private void ClearAllDocumentTypes()
    {
        selectedDocTypeIds = new HashSet<int>();
    }

    private void SelectAllDocumentTypes()
    {
        if (allDocumentTypes != null)
        {
            selectedDocTypeIds = allDocumentTypes.Select(dt => dt.DtId).ToHashSet();
        }
    }

    private async Task SearchUserToCopyFrom()
    {
        if (string.IsNullOrWhiteSpace(copyFromUserSearch) || copyFromUserSearch.Length < 3)
            return;

        copyFromUserSearched = true;
        selectedSourceUser = null; // Clear selection when searching again

        try
        {
            copyFromUserResults = await UserPermissionService.GetAllUsersAsync(copyFromUserSearch);
            // Exclude the current user from results
            if (selectedUser != null)
            {
                copyFromUserResults = copyFromUserResults
                    .Where(u => u.UserId != selectedUser.UserId)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            batchModalErrorMessage = $"Error searching users: {ex.Message}";
            Logger.LogError(ex, "Error searching users to copy from");
        }
    }

    private void SelectSourceUser(DocuScanUserDto user)
    {
        // Toggle selection - if already selected, deselect
        if (selectedSourceUser?.UserId == user.UserId)
        {
            selectedSourceUser = null;
        }
        else
        {
            selectedSourceUser = user;
        }
    }

    private void ClearSelectedSourceUser()
    {
        selectedSourceUser = null;
    }

    private async Task ApplyCopyFromSelectedUser()
    {
        if (selectedSourceUser == null) return;
        await CopyPrivilegesFromUser(selectedSourceUser);
    }

    private async Task CopyPrivilegesFromUser(DocuScanUserDto sourceUser)
    {
        try
        {
            // Get the source user's permissions
            var sourcePermissions = await UserPermissionService.GetByUserIdAsync(sourceUser.UserId);

            // Extract document type IDs from source user
            var sourceDocTypeIds = sourcePermissions
                .Where(p => p.DocumentTypeId.HasValue)
                .Select(p => p.DocumentTypeId!.Value)
                .ToList();

            // Count how many are already selected before adding
            int alreadySelected = sourceDocTypeIds.Count(id => selectedDocTypeIds.Contains(id));
            int newlySelected = 0;

            // Create new HashSet with merged values to trigger Blazor change detection
            var newSelection = new HashSet<int>(selectedDocTypeIds);
            foreach (var docTypeId in sourceDocTypeIds)
            {
                // Only count as newly selected if not already in the set
                if (newSelection.Add(docTypeId))
                {
                    newlySelected++;
                }
            }
            selectedDocTypeIds = newSelection;

            // Build informative message
            if (newlySelected > 0)
            {
                batchModalSuccessMessage = $"Selected {newlySelected} new document type(s) from {sourceUser.AccountName}. " +
                    (alreadySelected > 0 ? $"{alreadySelected} were already selected." : "");
            }
            else
            {
                batchModalSuccessMessage = $"All {sourceDocTypeIds.Count} document type(s) from {sourceUser.AccountName} were already selected.";
            }

            Logger.LogInformation("Copied privileges from {SourceUser}: {NewlySelected} newly selected, {AlreadySelected} already selected",
                sourceUser.AccountName, newlySelected, alreadySelected);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            batchModalErrorMessage = $"Error copying privileges: {ex.Message}";
            Logger.LogError(ex, "Error copying privileges from user {UserId}", sourceUser.UserId);
        }
    }

    private async Task ApplyBatchDocumentTypes()
    {
        if (selectedUser == null) return;

        isSavingBatch = true;
        batchModalErrorMessage = null;
        batchModalSuccessMessage = null;

        try
        {
            // Step 1: Remove any "all document types" permission (DocumentTypeId = null)
            // This ensures that batch edit overrides the global access
            var currentPermissions = await UserPermissionService.GetByUserIdAsync(selectedUser.UserId);
            var nullPermissions = currentPermissions.Where(p => !p.DocumentTypeId.HasValue).ToList();

            int nullPermissionsDeleted = 0;
            foreach (var nullPermission in nullPermissions)
            {
                await UserPermissionService.DeleteAsync(nullPermission.Id);
                nullPermissionsDeleted++;
                Logger.LogInformation("Deleted 'all document types' permission {PermissionId} for user {UserId}",
                    nullPermission.Id, selectedUser.UserId);
            }

            // Step 2: Apply batch update for specific document types
            var dto = new BatchUpdateDocumentTypePermissionsDto
            {
                UserId = selectedUser.UserId,
                DocumentTypeIds = selectedDocTypeIds.ToList()
            };

            var result = await UserPermissionService.BatchUpdateDocumentTypePermissionsAsync(dto);

            Logger.LogInformation("Batch update complete: Added={Added}, Removed={Removed}, NullRemoved={NullRemoved}, Total={Total}",
                result.PermissionsAdded, result.PermissionsRemoved, nullPermissionsDeleted, result.TotalPermissions);

            // Show success and close modal
            if (selectedDocTypeIds.Count == 0)
            {
                saveSuccessMessage = $"All permissions revoked. User no longer has access to any document types.";
            }
            else
            {
                var message = $"Batch update complete: {result.PermissionsAdded} added, {result.PermissionsRemoved} removed";
                if (nullPermissionsDeleted > 0)
                {
                    message += $", removed 'all document types' access";
                }
                message += $". Total: {result.TotalPermissions} permission(s).";
                saveSuccessMessage = message;
            }

            // Reload permissions list and user count
            await LoadUserPermissions();
            await LoadUsers();

            // Update selectedUser's permission count in UI
            if (selectedUser != null)
            {
                selectedUser.PermissionCount = result.TotalPermissions;
            }

            // Close modal
            CloseBatchDocTypeModal();
        }
        catch (Exception ex)
        {
            batchModalErrorMessage = $"Error applying batch update: {ex.Message}";
            Logger.LogError(ex, "Error applying batch document type update for user {UserId}", selectedUser.UserId);
        }
        finally
        {
            isSavingBatch = false;
        }
    }

    private async Task GrantAllDocumentTypesAccess()
    {
        if (selectedUser == null) return;

        // Confirm with user before proceeding
        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"This will replace ALL existing permissions for {selectedUser.AccountName} with a single permission granting access to ALL document types. Continue?"
        );

        if (!confirmed) return;

        saveErrorMessage = null;
        saveSuccessMessage = null;

        try
        {
            Logger.LogInformation("Granting all document types access to user {UserId}", selectedUser.UserId);

            // Step 1: Get all current permissions
            var currentPermissions = await UserPermissionService.GetByUserIdAsync(selectedUser.UserId);

            // Step 2: Delete all existing permissions
            foreach (var permission in currentPermissions)
            {
                await UserPermissionService.DeleteAsync(permission.Id);
                Logger.LogInformation("Deleted permission {PermissionId} for user {UserId}", permission.Id, selectedUser.UserId);
            }

            // Step 3: Create a single permission with DocumentTypeId = null
            var createDto = new CreateUserPermissionDto
            {
                UserId = selectedUser.UserId,
                DocumentTypeId = null
            };

            await UserPermissionService.CreateAsync(createDto);
            Logger.LogInformation("Created 'all document types' permission for user {UserId}", selectedUser.UserId);

            saveSuccessMessage = $"Successfully granted {selectedUser.AccountName} access to all document types!";

            // Reload permissions list and user count
            await LoadUserPermissions();
            await LoadUsers();

            // Update selectedUser's permission count in UI
            if (selectedUser != null)
            {
                selectedUser.PermissionCount = 1;
            }
        }
        catch (Exception ex)
        {
            saveErrorMessage = $"Error granting all document types access: {ex.Message}";
            Logger.LogError(ex, "Error granting all document types access for user {UserId}", selectedUser.UserId);
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
