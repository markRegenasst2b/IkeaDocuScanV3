@page "/excel-preview"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<div class="excel-preview-container">
    <div class="excel-preview-header">
        <h3>@pageTitle</h3>
        <p class="text-muted">Preview your data before exporting to Excel</p>
    </div>

    @if (contextInfo != null && contextInfo.Any())
    {
        <div class="filter-context-box">
            <h5>
                <i class="bi bi-info-circle"></i> <text>Context Information</text>
            </h5>
            <div class="filter-badges">
                @foreach (var item in contextInfo)
                {
                    <span class="badge bg-info">@item.Key: @item.Value</span>
                }
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading data preview...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong><i class="bi bi-exclamation-triangle"></i> Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }
    else if (!HasData())
    {
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-info-circle"></i> No data available to preview.
        </div>
    }
    else
    {
        <!-- Data Summary -->
        <div class="data-summary">
            <div class="summary-item">
                <strong>Total Records:</strong> <span class="badge bg-primary">@totalRecords</span>
            </div>
            <div class="summary-item">
                <strong>Columns:</strong> <span class="badge bg-secondary">@columnMetadata.Count</span>
            </div>
        </div>

        <!-- Paging Controls (Top) -->
        <div class="paging-controls">
            <div class="rows-per-page">
                <label>Rows per page:</label>
                <select class="form-select form-select-sm" @bind="rowsPerPage" @bind:after="OnRowsPerPageChanged">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="100">100</option>
                </select>
            </div>

            <div class="page-info">
                <span>Showing @GetStartRow()-@GetEndRow() of @totalRecords records</span>
            </div>

            <div class="page-navigation">
                <button class="btn btn-sm btn-outline-secondary" @onclick="FirstPage" disabled="@(currentPage == 1)">
                    <i class="bi bi-chevron-double-left"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                    <i class="bi bi-chevron-left"></i> Previous
                </button>
                <span class="page-indicator">Page @currentPage of @totalPages</span>
                <button class="btn btn-sm btn-outline-secondary" @onclick="NextPage" disabled="@(currentPage >= totalPages)">
                    Next <i class="bi bi-chevron-right"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="LastPage" disabled="@(currentPage >= totalPages)">
                    <i class="bi bi-chevron-double-right"></i>
                </button>
            </div>
        </div>

        <!-- Data Preview Table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover excel-preview-table">
                <thead class="table-primary">
                    <tr>
                        @foreach (var column in columnMetadata)
                        {
                            <th>@column.DisplayName</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in GetPagedData())
                    {
                        <tr>
                            @foreach (var column in columnMetadata)
                            {
                                <td class="@GetCellClass(column.DataType)">
                                    @GetCellValue(item, column)
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Paging Controls (Bottom) -->
        <div class="paging-controls">
            <div class="page-info">
                <span>Page @currentPage of @totalPages</span>
            </div>
            <div class="page-navigation">
                <button class="btn btn-sm btn-outline-secondary" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                    <i class="bi bi-chevron-left"></i> Previous
                </button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="NextPage" disabled="@(currentPage >= totalPages)">
                    Next <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Actions -->
        <div class="export-actions">
            <button class="btn btn-outline-secondary btn-lg" @onclick="Cancel">
                <i class="bi bi-arrow-left"></i> Back
            </button>
        </div>
    }
</div>

@code {
    // Component will be implemented in code-behind
}
